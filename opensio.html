<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhatsApp API Server Connect</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

  <style>
    :root { --brand:#5b73e8; --muted:#6b7280; --danger: #ef4444; }
    body { font-family: 'Inter', sans-serif; background: #f5f7fb; color: #333; margin: 0; padding: 0; }
    .container-fluid { max-width: 1200px; margin: 36px auto; padding: 0 16px; }
    .card { background: #fff; border-radius: 14px; box-shadow: 0 8px 25px rgba(16,24,40,0.06); padding: 20px; margin-bottom: 20px; border: 0; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); background: transparent; }
    h3, h4 { margin: 0; font-weight: 700; color: #1e293b; }
    .btn { padding: 10px 18px; border-radius: 10px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: .2s ease-in-out; display: inline-flex; align-items: center; gap: 8px; }
    .btn-danger { background: #fee2e2; color: #b91c1c; }
    .btn-danger:hover { background: #fecaca; transform: translateY(-1px); }
    .qr-area { min-height: 380px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; border: 2px dashed #e2e8f0; border-radius: 12px; margin-top: 15px; background: #fafafa; }
    #qrImage { max-width: 260px; border-radius: 10px; border: 1px solid #ddd; padding: 10px; background: white; display: none; }
    .spinner { border: 4px solid rgba(0,0,0,0.05); border-left-color: var(--brand); width: 45px; height: 45px; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .profile-card { background: #f0fdf4; border: 1px solid #bcf0da; color: #166534; padding: 25px; border-radius: 12px; width: 100%; text-align: center; }
    .profile-img { width: 90px; height: 90px; border-radius: 50%; border: 4px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); object-fit: cover; margin-bottom: 15px; }
    footer { text-align: center; padding: 30px; color: var(--muted); font-size: 14px; }
    footer a { color: var(--brand); font-weight: 600; text-decoration: none; }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h3><i class="fa-brands fa-whatsapp text-success"></i> WhatsApp API</h3>
          <button class="btn btn-danger" id="logoutBtn">
            <i class="fa-solid fa-power-off"></i> Logout & Restart
          </button>
        </div>
        <div class="card-body p-0">
          <div id="qrArea" class="qr-area">
            <div class="spinner" id="mainSpinner"></div>
            <p class="mt-3 text-muted" id="statusText">Checking connection...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-header"><h4>Status Info</h4></div>
        <p class="mt-3 text-muted">A connection message is sent automatically to verify the gateway.</p>
        <div class="alert alert-info py-2" style="font-size: 12px;">
          <strong>Admin Number:</strong> 919567664972
        </div>
      </div>
    </div>
  </div>
</div>

<footer>&copy; <script>document.write(new Date().getFullYear())</script> WhatsApp API Server</footer>

<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
  const API_BASE = "https://whats-api.opensio.co.in/api";
  const SESSION_ID = "20250107";
  const API_KEY = "ee1a9bc9348141c5867893737aa878cc";

  // Persistent flag to ensure message only sends once per successful link
  let messageSent = localStorage.getItem("autoMsgSent") === "true";
  let isRestarting = false;

  document.addEventListener("DOMContentLoaded", () => {
    checkSessionStatus();
    setInterval(() => { if(!isRestarting) checkSessionStatus(); }, 5000);
    document.getElementById("logoutBtn").addEventListener("click", forceLogout);
  });

  function toast(msg, type = "success") {
    Toastify({
      text: msg,
      duration: 3000,
      gravity: "top",
      position: "center",
      style: { background: type === "success" ? "#10b981" : "#ef4444", borderRadius: "10px" }
    }).showToast();
  }

  function checkSessionStatus() {
    fetch(`${API_BASE}/sessions/${SESSION_ID}`, { headers: { "X-Api-Key": API_KEY } })
      .then(res => res.json())
      .then(data => {
        if (data && data.status === "WORKING") {
          showConnected(data);
        } else {
          showDisconnected();
          loadQR();
        }
      })
      .catch(() => showDisconnected());
  }

  function showConnected(data) {
    const qrArea = document.getElementById("qrArea");
    if (qrArea.dataset.state === "connected") return;

    fetch(`${API_BASE}/${SESSION_ID}/profile`, { headers: { "X-Api-Key": API_KEY } })
      .then(res => res.json())
      .then(profile => {
        qrArea.dataset.state = "connected";
        const name = profile.name || data?.me?.pushName || "Fr. Francis Sales Library";
        const phone = (profile.id || data?.me?.id || "").split('@')[0];
        
        qrArea.innerHTML = `
          <div class="profile-card">
            <img src="${profile.picture || 'https://ui-avatars.com/api/?name='+name}" class="profile-img" />
            <h4>API Connected</h4>
            <div class="mt-2"><strong>User:</strong> ${name}</div>
            <div><strong>Phone:</strong> ${phone}</div>
          </div>
        `;

        // TRIGGER MESSAGE ONLY ONCE
        if (!messageSent) {
          sendMyTemplate(phone, name);
        }
      })
      .catch(() => {
        qrArea.innerHTML = `<div class="profile-card"><h4>Connected</h4></div>`;
      });
  }

  function showDisconnected() {
    const qrArea = document.getElementById("qrArea");
    if (qrArea.dataset.state === "disconnected") return;
    qrArea.dataset.state = "disconnected";
    qrArea.innerHTML = `<div class="spinner" id="spinnerInner"></div><img id="qrImage" /><p class="mt-3 text-muted">Awaiting QR Code...</p>`;
  }

  async function loadQR(retries = 5) {
    const qrImg = document.getElementById("qrImage");
    if (!qrImg || qrImg.style.display === "block") return;
    try {
      const res = await fetch(`${API_BASE}/${SESSION_ID}/auth/qr?format=image`, { headers: { "X-Api-Key": API_KEY } });
      if (res.status === 404 && retries > 0) { setTimeout(() => loadQR(retries - 1), 2000); return; }
      const blob = await res.blob();
      const spinner = document.getElementById("spinnerInner");
      if(spinner) spinner.style.display = "none";
      qrImg.src = URL.createObjectURL(blob);
      qrImg.style.display = "block";
    } catch (err) {}
  }

  async function forceLogout() {
    isRestarting = true;
    const qrArea = document.getElementById("qrArea");
    qrArea.dataset.state = "restarting";
    toast("Logging out...", "error");
    qrArea.innerHTML = `<div class="spinner"></div><p class="mt-3">Restarting session...</p>`;

    try {
      await fetch(`${API_BASE}/sessions/${SESSION_ID}/logout`, { method: "POST", headers: { "X-Api-Key": API_KEY } });
      await fetch(`${API_BASE}/sessions/start`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-Api-Key": API_KEY },
        body: JSON.stringify({ name: SESSION_ID })
      });
      
      // Reset the sent flag so the NEXT connection sends the message again
      localStorage.removeItem("autoMsgSent");
      messageSent = false;

      setTimeout(() => { isRestarting = false; showDisconnected(); loadQR(); }, 4000);
    } catch (e) {
      isRestarting = false;
      checkSessionStatus();
    }
  }

  function sendMyTemplate(connectedNumber, pushName) {
    // Exact template requested
    const messageText = `WhatsApp (${connectedNumber} - ${pushName}) with session ID ${SESSION_ID} is connected to API server successfully!`;
    const adminNumber = "919567664972"; 

    // Marking as sent immediately to prevent race conditions
    messageSent = true;
    localStorage.setItem("autoMsgSent", "true");

    // Only sending to the connected number as requested (can add adminNumber to targets if needed)
    const target = `${connectedNumber}@c.us`;

    fetch(`${API_BASE}/sendText`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-Api-Key": API_KEY },
        body: JSON.stringify({ chatId: target, text: messageText, session: SESSION_ID })
    }).then(() => {
        toast("Template message sent successfully!", "success");
    }).catch(() => {
        // If it fails, allow retry on next check
        messageSent = false;
        localStorage.removeItem("autoMsgSent");
    });
  }
</script>
</body>
</html>
