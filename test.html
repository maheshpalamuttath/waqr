<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>WhatsApp Connect</title>

  <!-- Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700">

  <!-- Icons -->
  <link rel="stylesheet" href="https://tinyurl.com/2rwemhe6/assets/vendor/nucleo/css/nucleo.css">
  <link rel="stylesheet" href="https://tinyurl.com/2rwemhe6/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css">

  <!-- CSS -->
  <link rel="stylesheet" href="https://tinyurl.com/2rwemhe6/assets/css/argon.css">
  <link rel="stylesheet" href="https://tinyurl.com/2rwemhe6/assets/css/custom.css">
  <link rel="stylesheet" href="https://tinyurl.com/2rwemhe6/assets/plugins/toastify-js/src/toastify.css">

  <style>
    .spinner {
      border: 4px solid rgba(0, 0, 0, .1);
      border-left-color: #3b5998;
      border-radius: 50%;
      width: 50px; height: 50px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .qr-area {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 260px;
      text-align: center;
    }
  </style>
</head>

<body>

<div class="container-fluid mt-5">
  <div class="row justify-content-center">

    <!-- LEFT PANEL -->
    <div class="col-sm-8">
      <div class="card card-neutral">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4>WhatsApp Connect</h4>
          <button class="btn btn-sm btn-neutral" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>

        <div class="card-body">
          <div class="qr-area" id="qrArea">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="col-sm-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4>How To Scan?</h4>
          <a href="#" class="btn btn-sm btn-neutral">
            <i class="fas fa-lightbulb"></i>&nbsp;Guide
          </a>
        </div>

        <div class="card-body">
          <img src="https://tinyurl.com/2rwemhe6/uploads/scan-demo.gif" class="w-100">
        </div>

        <div class="card-footer">
          <div class="activities">

            <div class="activity">
              <div class="activity-icon bg-primary text-white shadow-primary">
                <i class="ni ni-mobile-button"></i>
              </div>
              <div class="activity-detail">
                <span class="text-job text-primary">Step 1</span>
                <p>Open WhatsApp → Menu → Linked Devices</p>
              </div>
            </div>

            <div class="activity">
              <div class="activity-icon bg-primary text-white shadow-primary">
                <i class="fa fa-qrcode"></i>
              </div>
              <div class="activity-detail">
                <span class="text-job text-primary">Step 2</span>
                <p>Tap “Link a Device” and scan the QR code</p>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script src="https://tinyurl.com/2rwemhe6/assets/plugins/toastify-js/src/toastify.js"></script>

<script>
/* ---------------------------------------------------------
   CONFIG (Edit only this section)
--------------------------------------------------------- */
const CONFIG = {
  API_BASE: "https://whats-api.opensio.co.in/api",
  SESSION_ID: "20250818",
  API_KEY: "ee1a9bc9348141c5867893737aa878cc",

  ENDPOINTS: {
    session: (id) => `/sessions/${id}`,
    logout: (id) => `/sessions/${id}/logout`,
    qr: (id) => `/${id}/auth/qr?format=image`,
  }
};


/* ---------------------------------------------------------
  MINI API WRAPPER
--------------------------------------------------------- */
async function apiRequest(url, options = {}) {
  try {
    const res = await fetch(CONFIG.API_BASE + url, {
      ...options,
      headers: {
        "X-Api-Key": CONFIG.API_KEY,
        ...(options.headers || {})
      }
    });

    if (options.isImage) return res.blob();
    return res.json();

  } catch (err) {
    console.error("API Error:", err);
    return null;
  }
}


/* ---------------------------------------------------------
   UI HELPERS
--------------------------------------------------------- */
function toast(msg, type="success") {
  Toastify({
    text: msg,
    duration: 3000,
    gravity: "top",
    position: "right",
    backgroundColor: type === "success" ? "#28a745" : "#dc3545"
  }).showToast();
}

function showConnected(data) {
  document.getElementById("qrArea").innerHTML = `
    <div class="alert alert-success w-100">
      <h4>WhatsApp Session <b>${data.name}</b> is Connected ✔</h4>
      <p>User: <b>${data?.me?.pushName || "Unknown"}</b></p>
    </div>
  `;
}

function showDisconnected() {
  const qrArea = document.getElementById("qrArea");

  qrArea.innerHTML = `
    <div id="spinner" class="spinner"></div>
    <img id="qrImage" class="img-fluid" style="display:none;">

    <p class="mt-3 text-danger">
      Session not connected.<br>Click Reset to load a new QR code.
    </p>

    <button id="resetSessionBtn" class="btn btn-warning mt-2">
      <i class="fas fa-redo-alt"></i> Reset Session
    </button>
  `;

  document.getElementById("resetSessionBtn").addEventListener("click", forceLogout);
}


/* ---------------------------------------------------------
   QR CODE LOADER
--------------------------------------------------------- */
async function loadQR() {
  const qrImage = document.getElementById("qrImage");
  const spinner = document.getElementById("spinner");

  const blob = await apiRequest(CONFIG.ENDPOINTS.qr(CONFIG.SESSION_ID), { isImage: true });

  if (blob) {
    qrImage.src = URL.createObjectURL(blob);
    qrImage.style.display = "block";
    spinner.style.display = "none";
  } else {
    spinner.style.display = "none";
    qrImage.alt = "Failed to load QR";
  }
}


/* ---------------------------------------------------------
   SESSION CHECK
--------------------------------------------------------- */
async function checkSessionStatus() {
  const data = await apiRequest(CONFIG.ENDPOINTS.session(CONFIG.SESSION_ID));

  if (data && data.status === "WORKING") {
    showConnected(data);
  } else {
    showDisconnected();
    loadQR();
  }
}


/* ---------------------------------------------------------
   FORCE LOGOUT
--------------------------------------------------------- */
async function forceLogout() {
  const btn = document.getElementById("resetSessionBtn") || document.getElementById("logoutBtn");
  btn.disabled = true;

  toast("Resetting WhatsApp session…", "error");

  await apiRequest(CONFIG.ENDPOINTS.logout(CONFIG.SESSION_ID), {
    method: "POST"
  });

  setTimeout(() => {
    showDisconnected();
    loadQR();
    toast("Session reset. Scan the new QR.", "success");
    btn.disabled = false;
  }, 1200);
}


/* ---------------------------------------------------------
   BOOTSTRAP
--------------------------------------------------------- */
document.addEventListener("DOMContentLoaded", () => {
  checkSessionStatus();
  setInterval(checkSessionStatus, 5000);
  document.getElementById("logoutBtn").addEventListener("click", forceLogout);
});
</script>

</body>
</html>
