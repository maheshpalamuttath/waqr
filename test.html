<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>WhatsApp Connect</title>

  <!-- Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700">

  <!-- Icons -->
  <link rel="stylesheet" href="https://tinyurl.com/2rwemhe6/assets/vendor/nucleo/css/nucleo.css">
  <link rel="stylesheet" href="https://tinyurl.com/2rwemhe6/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css">

  <!-- CSS -->
  <link rel="stylesheet" href="https://tinyurl.com/2rwemhe6/assets/css/argon.css">
  <link rel="stylesheet" href="https://tinyurl.com/2rwemhe6/assets/css/custom.css">
  <link rel="stylesheet" href="https://tinyurl.com/2rwemhe6/assets/plugins/toastify-js/src/toastify.css">

  <style>
    .spinner {
      border: 4px solid rgba(0, 0, 0, .1);
      border-left-color: #3b5998;
      border-radius: 50%;
      width: 50px; height: 50px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .qr-area {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 260px;
      text-align: center;
    }
  </style>
</head>

<body>

<div class="container-fluid mt-5">
  <div class="row justify-content-center">

    <div class="col-sm-8">
      <div class="card card-neutral">

        <div class="card-header d-flex justify-content-between align-items-center">
          <h4>WhatsApp Connect</h4>

          <button class="btn btn-sm btn-neutral" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>

        <div class="card-body">
          <div class="qr-area" id="qrArea">
            <div class="spinner"></div>
          </div>
        </div>

      </div>
    </div>

    <div class="col-sm-4">
      <div class="card">

        <div class="card-header d-flex justify-content-between align-items-center">
          <h4>How To Scan?</h4>
          <a href="#" class="btn btn-sm btn-neutral">
            <i class="fas fa-lightbulb"></i>&nbsp;Guide
          </a>
        </div>

        <div class="card-body">
          <img src="https://tinyurl.com/2rwemhe6/uploads/scan-demo.gif" class="w-100">
        </div>

        <div class="card-footer">
          <div class="activities">

            <div class="activity">
              <div class="activity-icon bg-primary text-white shadow-primary">
                <i class="ni ni-mobile-button"></i>
              </div>
              <div class="activity-detail">
                <span class="text-job text-primary">Step 1</span>
                <p>Open WhatsApp → Menu → Linked Devices</p>
              </div>
            </div>

            <div class="activity">
              <div class="activity-icon bg-primary text-white shadow-primary">
                <i class="fa fa-qrcode"></i>
              </div>
              <div class="activity-detail">
                <span class="text-job text-primary">Step 2</span>
                <p>Tap “Link a Device” and scan the QR code</p>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script src="https://tinyurl.com/2rwemhe6/assets/plugins/toastify-js/src/toastify.js"></script>

<script>
  const API_BASE = "https://whats-api.opensio.co.in/api";
  const SESSION_ID = "20250818";
  const API_KEY = "ee1a9bc9348141c5867893737aa878cc";

  document.addEventListener("DOMContentLoaded", () => {
    checkSessionStatus();

    // Auto-refresh every 5 seconds
    setInterval(checkSessionStatus, 5000);

    document.getElementById("logoutBtn").addEventListener("click", forceLogout);
  });

  // SHOW TOAST
  function toast(msg, type="success") {
    Toastify({
      text: msg,
      duration: 3000,
      gravity: "top",
      position: "right",
      backgroundColor: type === "success" ? "#28a745" : "#dc3545"
    }).showToast();
  }

  // CHECK SESSION
  function checkSessionStatus() {
    fetch(`${API_BASE}/sessions/${SESSION_ID}`, {
      headers: { "X-Api-Key": API_KEY }
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "WORKING") {
        showConnected(data);
      } else {
        showDisconnected();
        loadQR();
      }
    })
    .catch(() => {
      showDisconnected();
      loadQR();
    });
  }

  // UI: CONNECTED
  function showConnected(data) {
    const qrArea = document.getElementById("qrArea");

    qrArea.innerHTML = `
      <div class="alert alert-success w-100">
        <h4>WhatsApp Session <b>${data.name}</b> is Connected ✔</h4>
        <p>User: <b>${data?.me?.pushName || "Unknown"}</b></p>
      </div>
    `;
  }

  // UI: DISCONNECTED + RESET BUTTON
  function showDisconnected() {
    const qrArea = document.getElementById("qrArea");

    qrArea.innerHTML = `
      <div id="spinner" class="spinner"></div>
      <img id="qrImage" class="img-fluid" style="display:none;">

      <p class="mt-3 text-danger">
        Session not connected.<br>Click Reset to load a new QR code.
      </p>

      <button id="resetSessionBtn" class="btn btn-warning mt-2">
        <i class="fas fa-redo-alt"></i> Reset Session
      </button>
    `;

    document.getElementById("resetSessionBtn").addEventListener("click", forceLogout);
  }

  // LOAD QR
  function loadQR() {
    const qrImage = document.getElementById("qrImage");
    const spinner = document.getElementById("spinner");

    fetch(`${API_BASE}/${SESSION_ID}/auth/qr?format=image`, {
      headers: { "accept": "image/png", "X-Api-Key": API_KEY }
    })
    .then(res => res.blob())
    .then(blob => {
      qrImage.src = URL.createObjectURL(blob);
      qrImage.style.display = "block";
      spinner.style.display = "none";
    })
    .catch(() => {
      spinner.style.display = "none";
      qrImage.alt = "Failed to load QR";
    });
  }

  // FORCE LOGOUT
  function forceLogout() {
    const btn = document.getElementById("resetSessionBtn") || document.getElementById("logoutBtn");
    btn.disabled = true;

    toast("Resetting WhatsApp session…", "error");

    fetch(`${API_BASE}/sessions/${SESSION_ID}/logout`, {
      method: "POST",
      headers: { "X-Api-Key": API_KEY }
    })
    .then(res => res.json())
    .then(() => {
      setTimeout(() => {
        showDisconnected();
        loadQR();
        toast("Session reset. Scan the new QR.", "success");
        btn.disabled = false;
      }, 1200);
    })
    .catch(() => {
      toast("Logout failed. Try again.", "error");
      btn.disabled = false;
    });
  }
</script>

</body>
</html>
